ARG IMAGE

FROM $IMAGE AS altbase

ARG IMAGE
ARG IMAGE_TYPE="nightly"
ARG YEAR
ARG MONTH
ARG DAY

ENV IMAGE_NAME="core"
ENV IMAGE=$IMAGE
ENV IMAGE_TYPE=$IMAGE_TYPE
ENV YEAR=$YEAR
ENV MONTH=$MONTH
ENV DAY=$DAY

RUN apt-get update
RUN apt-get install -y ca-certificates
RUN apt-get install -y apm bootc

# Needs for apm build validation
RUN --mount=type=bind,ro,source=./src/resources/tools/install-inlcudes.yml,target=/etc/apm/image.yml \
    apm system image build;

RUN \
    if [ "$IMAGE_TYPE" = "nightly" ]; then \
        cp -f /usr/share/apm/includes/common/latest-apm.yml /etc/apm/image.yml \
        apm system image build; \
        rm -f /usr/share/apm/includes/common/latest-apm.yml \
    fi

RUN --mount=type=bind,ro,source=./src/image.yml,target=/etc/apm/image.yml \
    --mount=type=bind,ro,source=./src/resources,target=/etc/apm/resources \
    /etc/apm/resources/tools/image-prepare.sh && \
    apm system image build

WORKDIR /

CMD ["/sbin/init"]
