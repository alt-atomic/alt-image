ARG IMAGE

FROM $IMAGE AS altbase

ARG IMAGE
ARG IMAGE_TYPE="nightly"
ARG YEAR
ARG MONTH
ARG DAY

ENV IMAGE_NAME="core"
ENV IMAGE=$IMAGE
ENV IMAGE_TYPE=$IMAGE_TYPE
ENV YEAR=$YEAR
ENV MONTH=$MONTH
ENV DAY=$DAY

RUN apt-get update
RUN apt-get install -y ca-certificates
# We must install bootc for apm IsAtomic check
RUN apt-get install -y apm bootc
# RUN cd /var/cache/apt/archives && \
#     apt-get install -y https://git.altlinux.org/tasks/401049/build/300/x86_64/rpms/apm-0.2.2-alt1.x86_64.rpm && \
#     cd /

RUN --mount=type=bind,source=./src,target=/etc/apm \
    /etc/apm/resources/tools/image-prepare.sh && \
    apm system image build

WORKDIR /

CMD ["/sbin/init"]
