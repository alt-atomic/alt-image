ARG IMAGE

FROM $IMAGE AS altbase

ARG IMAGE
ARG IMAGE_TYPE="nightly"
ARG YEAR
ARG MONTH
ARG DAY

ENV IMAGE_NAME="core"
ENV IMAGE=$IMAGE
ENV IMAGE_TYPE=$IMAGE_TYPE
ENV YEAR=$YEAR
ENV MONTH=$MONTH
ENV DAY=$DAY

RUN apt-get update
RUN apt-get install -y ca-certificates
RUN apt-get install -y apm bootc

RUN --mount=type=bind,ro,source=./src/latest-apm.yml,target=/etc/apm/image.yml \
    apm system image build;

# Needs for apm build validation
RUN --mount=type=bind,ro,source=./src/install-includes.yml,target=/etc/apm/image.yml \
    apm system image build;

RUN --mount=type=bind,ro,source=./src/image.yml,target=/etc/apm/image.yml \
    --mount=type=bind,ro,source=./src/resources,target=/etc/apm/resources \
    /etc/apm/resources/tools/image-prepare.sh && \
    apm system image build

# Lint image
RUN bootc container lint

WORKDIR /

CMD ["/sbin/init"]
