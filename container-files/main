ARG IMAGE

FROM $IMAGE AS altbase

ARG IMAGE
ARG IMAGE_TYPE="nightly"
ARG YEAR
ARG MONTH
ARG DAY

ENV APM_BUILD_BUILD_TYPE=$IMAGE_TYPE
ENV APM_BUILD_IMAGE=$IMAGE
ENV APM_BUILD_REPO_DATE="${YEAR}/${MONTH}/${DAY}"

COPY src/image.yml /etc/apm/image.yml
COPY src/resources /etc/apm/resources

RUN apt-get update
RUN apt-get install -y ca-certificates
RUN apt-get install -y https://git.altlinux.org/tasks/399760/build/1100/x86_64/rpms/apm-0.1.10-alt1.x86_64.rpm

RUN /etc/apm/resources/tools/image-prepare.sh && \
    apm system image build && \
    rm -rf /etc/apm

# Стадия 2: Переход к пустому образу
FROM scratch

# Копируем всё содержимое из предыдущего образа
COPY --from=altbase / /

WORKDIR /

# Помечаем образ как bootc совместимый
LABEL containers.bootc=1

LABEL org.opencontainers.image.title="ALT Atomic Core"
LABEL org.opencontainers.image.description="Core image for ALT Atomic distros"
LABEL org.opencontainers.image.source="https://altlinux.space/alt-atomic/core"
LABEL org.opencontainers.image.licenses="GPL-3.0-or-later"
LABEL org.opencontainers.image.vendor="ALT Linux Team"

CMD ["/sbin/init"]
