image: ${{ Env.IMAGE }}

env:
  KERNEL_FLAVOUR: 6.12

modules:
  - name: Set repos
    type: repos
    body:
      branch: sisyphus
      date: ${{ Env.YEAR }}.${{ Env.MONTH }}.${{ Env.DAY }}
      clean: true
      name: ${{ Env.IMAGE_NAME }}

  - name: Initial includes
    type: include
    body:
      targets:
        - apt-rpm.yml
        - filesystem.yml
        - disable-bins.yml

  - type: packages
    body:
      update: true
      upgrade: true

  - name: Set branding
    type: branding
    body:
      name: alt-atomic-${{ Env.IMAGE_NAME }}
      build-type: ${{ Env.IMAGE_TYPE }}

  - name: Copy root
    type: copy
    body:
      source: root
      destination: /
      replace: true

  - type: include
    body:
      targets:
        - packages.yml
        - network.yml
        - systemd.yml
        - settings.yml
        - passwd.yml
    
  - name: Configurate grub
    type: shell
    body:
      command: scripts/grub.sh
    
  - name: Update kernel
    type: kernel
    body:
      flavour: ${{ Env.KERNEL_FLAVOUR }}
      modules:
        - drm
      rebuild-initrd-method: dracut

  - name: Cleanup
    type: include
    body:
      targets:
        - cleanup.yml
