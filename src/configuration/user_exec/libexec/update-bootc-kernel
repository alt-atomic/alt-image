#!/bin/bash
set -euo pipefail

PACKAGES=("$@")

if [[ ${#PACKAGES[@]} -eq 0 ]]; then
    echo "Error: No kernel packages specified."
    exit 1
fi

echo "Installing kernel packages: ${PACKAGES[*]}"

echo "Removing old kernels..."
INSTALLED_KERNELS=$(rpm -qa --queryformat '%{NAME}\n' | grep -E '^kernel-(image|modules)-' | sort -u || true)
if [[ -n "$INSTALLED_KERNELS" ]]; then
    echo "Found installed kernel packages:"
    echo "$INSTALLED_KERNELS"
    apt-get remove --purge -y $INSTALLED_KERNELS
else
    echo "No installed kernel packages found"
fi

echo "Cleaning kernel modules directory..."
rm -rf /usr/lib/modules/*

apt-get update
apt-get install -y "${PACKAGES[@]}"

KERNEL_DIR="/usr/lib/modules"

echo "Detecting kernel version..."
KERNEL_VERSION=$(ls "$KERNEL_DIR" | sort -V | tail -n 1)

if [[ -z "$KERNEL_VERSION" ]]; then
    echo "Error: No kernel version found in $KERNEL_DIR."
    exit 1
fi

# Copy vmlinuz for bootc
cp -f "/boot/vmlinuz-$KERNEL_VERSION" "$KERNEL_DIR/$KERNEL_VERSION/vmlinuz"

/usr/libexec/update-initramfs
